# 无线广播通信模拟说明

## 概述

本项目现在支持在Windows纯软件环境中模拟嵌入式设备的无线广播通信场景。通过UDP广播技术，实现了一主机多从机的无线通信模拟。

## 通信架构

### 端口配置
- **后端 (Backend)**: 8079端口
- **主机 (Master)**: 8080端口  
- **从机 (Slaves)**: 8081端口（广播端口）

### 通信模式

1. **后端 ↔ 主机**: UDP单播通信
   - 后端发送命令到主机 (8080)
   - 主机发送响应到后端 (8079)

2. **主机 → 从机**: UDP广播通信（模拟无线广播）
   - 主机向8081端口发送广播消息
   - 所有从机都能接收到广播消息
   - 支持广播ID (0xFFFFFFFF) 和特定设备ID

3. **从机 → 主机**: UDP单播通信（模拟无线响应）
   - 从机向主机8080端口发送响应
   - 每个从机独立响应

## 使用方法

### 1. 编译项目
```bash
mkdir build
cd build
cmake ..
cmake --build .
```

### 2. 启动程序

#### 方式一：单独启动各组件
```bash
# 终端1: 启动后端测试程序
./main

# 终端2: 启动主机服务器
./Master

# 终端3: 启动从机1
./Slave

# 终端4: 启动更多从机（需要修改设备ID）
# 可以启动多个Slave实例，但需要不同的设备ID
```

#### 方式二：使用多从机模拟器
```bash
# 终端1: 启动后端测试程序
./main

# 终端2: 启动主机服务器
./Master

# 终端3: 启动多从机模拟器（自动启动4个从机）
./MultiSlave
```

### 3. 测试广播通信

1. 从后端发送配置消息到主机
2. 主机处理后广播配置命令到所有从机
3. 所有从机接收广播消息并分别响应
4. 主机收集所有从机的响应

## 技术实现

### 广播机制
- 使用 `SO_BROADCAST` 套接字选项启用UDP广播
- 主机发送到广播地址 `127.255.255.255:8081`
- 从机监听 `INADDR_ANY:8081` 接收广播

### 多从机支持
- 每个从机使用不同的设备ID
- 所有从机监听同一个广播端口
- 通过 `SO_REUSEADDR` 选项允许端口复用
- 支持广播消息和定向消息

### 消息过滤
- 从机检查消息的目标ID
- 如果是广播ID (0xFFFFFFFF) 或自己的ID，则处理消息
- 否则忽略消息

## 广播通信流程

```
Backend(8079) ←→ Master(8080) ⇄ Slaves(8081)
                      ↓ broadcast
                 ┌────────────────┐
                 ↓    ↓    ↓    ↓
              Slave1 Slave2 Slave3 Slave4
                 ↑    ↑    ↑    ↑
                 └────┴────┴────┘
                   unicast responses
```

## 日志输出

### 主机日志
- 显示广播消息发送
- 显示从各从机接收的响应
- 显示设备管理信息

### 从机日志
- 显示接收到的广播消息
- 显示消息过滤结果
- 显示发送的响应消息
- 每个从机使用设备ID标识日志

## 优势

1. **真实模拟**: 准确模拟无线广播通信的特点
2. **多从机支持**: 可以同时运行多个从机实例
3. **易于调试**: 每个组件独立运行，便于观察通信过程
4. **扩展性好**: 可以轻松添加更多从机或修改通信协议

## 注意事项

1. **防火墙设置**: 确保Windows防火墙允许UDP广播通信
2. **端口占用**: 确保8079、8080、8081端口未被其他程序占用
3. **设备ID**: 每个从机必须有唯一的设备ID
4. **启动顺序**: 建议先启动主机，再启动后端和从机

## 扩展功能

### 添加更多从机
修改 `multi_slave_main.cpp` 中的设备ID列表：
```cpp
manager.addSlave(0x3732485B);  // Slave 1
manager.addSlave(0x3732485C);  // Slave 2
manager.addSlave(0x3732485D);  // Slave 3
manager.addSlave(0x3732485E);  // Slave 4
manager.addSlave(0x3732485F);  // Slave 5 (新增)
```

### 自定义广播地址
如需使用真实网络广播，可修改主机中的广播地址：
```cpp
// 使用网络广播地址（如 192.168.1.255）
slaveBroadcastAddr.sin_addr.s_addr = inet_addr("192.168.1.255");
```

这样就完成了在Windows纯软件环境中对嵌入式无线广播通信的完整模拟。 